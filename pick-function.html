<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Case study: the pick() function - Rust lifetimes: from 'static to ecstatic</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (true || document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> What is a &quot;lifetime&quot;?</div></li><li class="chapter-item expanded affix "><li class="part-title">Core notions</li><li class="chapter-item expanded "><a href="pick-function.html" class="active"><strong aria-hidden="true">2.</strong> Case study: the pick() function</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Chapter 1</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Bar</div></li><li class="chapter-item expanded affix "><li class="part-title">Reference</li><li class="chapter-item expanded "><a href="lifetime-elision-rules.html"><strong aria-hidden="true">5.</strong> Lifetime elision rules</a></li><li class="chapter-item expanded "><a href="variance-intro.html"><strong aria-hidden="true">6.</strong> Variance</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="covariance.html"><strong aria-hidden="true">6.1.</strong> Covariance: when lifetimes can shrink</a></li><li class="chapter-item expanded "><a href="contravariance.html"><strong aria-hidden="true">6.2.</strong> Contravariance: when lifetimes can grow</a></li><li class="chapter-item expanded "><a href="variance-rules.html"><strong aria-hidden="true">6.3.</strong> Variance rules: a recap</a></li></ol></li><li class="chapter-item expanded "><a href="return-position-impl-trait.html"><strong aria-hidden="true">7.</strong> Lifetime semantics of -&gt; impl Trait</a></li><li class="chapter-item expanded "><a href="intersection-lifetime.html"><strong aria-hidden="true">8.</strong> Intersection lifetime</a></li><li class="chapter-item expanded "><a href="async-fn.html"><strong aria-hidden="true">9.</strong> async fn unsugaring / lifetime</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Niche stuff</li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> impl&lt;#[may_dangle] …&gt; Drop</div></li><li class="spacer"></li><li class="chapter-item expanded "><a href="appendix.html"><strong aria-hidden="true">11.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="elided-lifetimes.html"><strong aria-hidden="true">11.1.</strong> Elided lifetimes / what is '_</a></li><li class="chapter-item expanded "><a href="usability.html"><strong aria-hidden="true">11.2.</strong> Trait + 'lifetime</a></li><li class="chapter-item expanded "><a href="subtyping-vs-coercions.html"><strong aria-hidden="true">11.3.</strong> Subtyping vs. Coercions</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><div>Closing thoughts</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Rust lifetimes: from 'static to ecstatic</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#case-study-the-pick-function" id="case-study-the-pick-function">Case study: the <code>pick()</code> function</a></h1>
<p>In these series we'll be dealing with kind of the lifetime-equivalent of the trolley problem: <code>fn pick(&amp;str, &amp;str) -&gt; &amp;str</code> and friends.</p>
<p>The body will always be along the lines of:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn pick(left: &amp;'_?? str, right: &amp;'_?? str)
  -&gt; &amp;'_?? str
{
    if ::rand::random() {
        left
    } else {
        right
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>And the whole question will be about what should we put instead of each <code>'_??</code>.</p>
<h4><a class="header" href="#lets-try-elision" id="lets-try-elision">Let's try elision?</a></h4>
<p>For starters, let's try the typical works-way-more-often-than-it-deserves do-no-overcomplicate approach of using <a href="./elided-lifetimes.html">elided lifetimes</a> everywhere:</p>
<pre><code class="language-rs">fn pick(left: &amp;'_ str, right: &amp;'_ str)
  -&gt; &amp;'_ str
</code></pre>
<p>❌ this fails because <del>I wanted to make your life miserable</del> the <a href="./lifetime-elision-rules.html">lifetime elision rules</a> do not handle this situation: the inputs are so symmetric there is no clear &quot;borrowee&quot; argument.</p>
<ul>
<li><b>👉 <a href="./lifetime-elision-rules.html">lifetime elision rules</a> 👈</b></li>
</ul>
<h4><a class="header" href="#lets-try-repeating" id="lets-try-repeating">Let's try repeating</a></h4>
<p>Now we could also try using distinct lifetime parameters for all three, but that will &quot;never&quot; work: we return a borrowing thing, so it has to be borrowing from at least one of the arguments, thus, <strong>in practice, a borrowing return type almost always has to involve a lifetime parameter that appears among one of the input types</strong>.</p>
<p>Given how symmetric our code is, the sensible thing to do now would be to repeat all the lifetimes:</p>
<pre><code class="language-rs">fn pick&lt;'ret&gt;(s1: &amp;'ret str, s2: &amp;'ret str)
  -&gt; &amp;'ret str
</code></pre>
<p>And this does:</p>
<ul>
<li>compile ✅</li>
<li>not result in unnecesarily restrictive API ✅</li>
</ul>
<p>Yay! 🥳</p>
<ul>
<li>
<p>Aside: beginners often forget about the latter. Massaging a signature so that it becomes compatible with a given implementation often means we are making that function <em>less compatible</em> with certain call-site situations. While it can often be an acceptable loss, or a necessary one, other times that initial <code>cargo check</code> passing can hide that the API has become near-uncallable.</p>
<p>That's why it is advisable to do this massaging of a function signature dance with an example usage / unit test next to it, so as to see the &quot;two sides&quot; of the caller/callee situation.</p>
</li>
</ul>
<h3><a class="header" href="#congratulations-puzzle-solved-now-to-the-next-puzzle" id="congratulations-puzzle-solved-now-to-the-next-puzzle">Congratulations, puzzle solved. Now to the next puzzle!</a></h3>
<p>Consider:</p>
<pre><code class="language-rs">use ::std::sync::{Arc, Mutex};

#[derive(Clone)]
struct Person&lt;'name&gt; {
    name: Arc&lt;Mutex&lt;&amp;'name str&gt;&gt;,
}

fn pick(p1: Person&lt;'_??&gt;, p2: Person&lt;'_??&gt;)
  -&gt; &amp;'_?? str
{
    if ::rand::random() {
        *p1.name.lock().unwrap()
    } else {
        *p2.name.lock().unwrap()
    }
}
</code></pre>
<p>and with the following test case:</p>
<pre><code class="language-rs">#[test]
fn test()
{
    let local = String::from(&quot;non-static&quot;);

    let p1: Person&lt;'static&gt; = Person {
        name: Arc::new(Mutex::new(&quot;static&quot;)),
    };
    let p2: Person&lt;'_&gt; = Person {
        name: Arc::new(Mutex::new(&amp;local)),
    };
    let choice = pick(p1, p2);
    dbg!(choice);
}
</code></pre>
<p>Now, if you try the <code>'ret</code>-everywhere approach, the test function will not compile!</p>
<pre><code class="language-rust ignore">error[E0597]: `local` does not live long enough
  --&gt; src/lib.rs:49:35
   |
45 |     let p1: Person&lt;'static&gt; = Person {
   |             --------------- type annotation requires that `local` be borrowed for `'static`
...
49 |         name: Arc::new(Mutex::new(&amp;local)),
   |                                   ^^^^^^ borrowed value does not live long enough
...
53 | }
   | - `local` dropped here while still borrowed
</code></pre>
<p>From the error message, we can guess that Rust is now convinced that our <code>p2: Person&lt;'_&gt;</code> is actually a <code>Person&lt;'static&gt;</code> (at which point it complains about <code>&amp;local</code> not being able to be borrowed for <code>'static</code> / <code>'forever</code> due to the impending doom that looms over the <code>local</code> variable).</p>
<p>But why is that? Well, remember how the input of our <code>pick()</code> function was <em>repeating</em> the same <code>'ret</code> lifetime parameter for both function arguments. Well, that's exactly what repeating a lifetime parameter means: lifetime equality! If <code>p1</code> involves a <code>'static</code> lifetime, then it means that <code>p2</code>'s to-be-inferred lifetime has to be <code>'static</code>. Hence the error.</p>
<ul>
<li>
<p>For the skeptical ones who may still think the lifetime of the return value may also be playing a role here (which it is not), and for the otherwise just curious people, here is an interesting thing: since having both function args involving the same lifetime parameter was enough to cause this restriction, we can actually get rid of the return type altogether (and thus the function body as well), and still have the same problem! 😄</p>
<pre><code class="language-rs">fn pick&lt;'ret&gt;(_: Person&lt;'ret&gt;, _: Person&lt;'ret&gt;)
// -&gt; no return type whatsoever
{
    // no meaningful body either 🙃
}
</code></pre>
</li>
</ul>
<p>Now, at this point we may wonder about the initial <code>&amp;str</code> case, and see if it also suffers from this problem (had we been overly optimistic?)</p>
<pre><code class="language-rs">fn pick&lt;'ret&gt;(s1: &amp;'ret str, s2: &amp;'ret str)
  -&gt; &amp;'ret str
{
    &quot;…&quot;
}

#[test]
fn test()
{
    let local = String::from(&quot;non-static&quot;);

    let s1: &amp;'static str = &quot;static&quot;;
    let s2: &amp;'_ str = &amp;local;
    let choice = pick(s1, s2);
    dbg!(choice);
}
</code></pre>
<p>Aaand… it does compile!</p>
<p>So, what has changed? Why/how does <code>&amp;'_ str</code> work but <code>Person&lt;'_&gt;</code> not?</p>
<p>And the answer is that the <code>'_</code> in <code>&amp;'_ str</code> is &quot;allowed to shrink&quot;, which is not the case for <code>Person&lt;'_&gt;</code>.</p>
<p>VARIANCE yadda yadda</p>
<p>Indeed, the main change here is that <code>Person&lt;'_&gt;</code>, contrary to <code>&amp;'_ str</code>, does not allow its lifetime <code>'_</code> to &quot;shrink&quot;; which is something the <code>'ret</code>-everywhere approach was (probably unknowingly) relying on for the signature not to be restrictive. As</p>
<pre><code class="language-rs">#[test]
fn test()
{
    let local1 = String::from(&quot;Jane&quot;);
    let local2 = String::from(&quot;Dove&quot;);

    let p1: Person&lt;'_&gt; = Person {
        name: Arc::new(Mutex::new(&amp;local1)),
    };
    let p2: Person&lt;'_&gt; = Person {
        name: Arc::new(Mutex::new(&amp;local2)),
    };
    let choice = pick(p1.clone(), p2.clone());
    dbg!(choice);
    if ::rand::random() {
        drop(p1); drop(local1);
        drop(p2); drop(local2);
    } else {
        drop(p2); drop(local2);
        drop(p1); drop(local1);
    }
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="lifetime-elision-rules.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="lifetime-elision-rules.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
